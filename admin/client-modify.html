<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>
        编辑信息
    </title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">

    <link rel="stylesheet" href="./css/font.css">
    <link rel="stylesheet" href="./css/index.css">
	<link rel="stylesheet" href="./lib/layui/css/layui.css" media="all">
    <script src="./lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="./js/index.js"></script>
	<script type="text/javascript" src="../js/base.js"></script>

</head>
<body>
   
	<script id="avatar" type="text/html">
		<img class="layui-upload-img" src="" style="height:164px;width:118px" id="avatarImg">
		<div style="width: 118px;">
			<div class="layui-progress layui-progress-big" lay-showpercent="yes" lay-filter="demo">
				<div class="layui-progress-bar" lay-percent=""></div>
			</div>	
		</div>
		<a name="list-progress"> </a>
		{{# if(d.AvatarPath === "") { }}
		<button type="button" class="layui-btn" style="width:118px" id="test1">上传照片</button>
		{{# } else { }}
		<button type="button" class="layui-btn" style="width:118px" id="test1">修改照片</button>
		{{# } }}
	</script>
   
<div class="layui-card">
    <form class="layui-form layui-form-pane" action="" id="modify" lay-filter="modify">
        <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">

			<input type="hidden" id="data">
			<div class="layui-tab-item layui-show">
				<table class="layui-table" lay-skin="line">
					<col class="layui-form-item"/>
					<col class="layui-form-item"/>
					<col class="layui-form-item"/>
					<tr>
						<td class="layui-form-item" width="118px" rowspan="4">
							<div class="layui-upload">
								<div class="layui-upload-list" id="avatardiv">

								</div>
							</div>
						</td>
						<td class="layui-form-item">
							<label class="layui-form-label">
								<span class='x-red'>*</span>姓名
							</label>
							<div class="layui-input-block">
								<input type="text" name="name" id="name" lay-verify="required" autocomplete="off" value="" placeholder="空制在6个汉字，12个字符以内"
									   class="layui-input">
							</div>
						</td>
					</tr>
					<tr>
						<td class="layui-form-item">
							<label class="layui-form-label">
								<span class='x-red'>*</span>身份证号
							</label>
							<div class="layui-input-block">
								<input type="text" name="chinaid" id="chinaid" lay-verify="required|identity" autocomplete="off" value="" class="layui-input">
							</div>
						</td>
					</tr>
					<tr>
						<td class="layui-form-item">
							<label class="layui-form-label">
								<span class='x-red'>*</span>性别
							</label>
							<div class="layui-input-block">
								<input type="text" name="sex" id="sex" lay-verify="" autocomplete="off" placeholder="根据身份证信息自动填写" value="" class="layui-input" disabled="disabled">
							</div>
						</td>
					</tr>
					<tr>
						<td class="layui-form-item">
							<label class="layui-form-label">
								<span class='x-red'>*</span>年龄
							</label>
							<div class="layui-input-block">
								<input type="text" lay-verify="required|number" placeholder="根据身份证信息自动填写" disabled="disabled" name="age" id="age" autocomplete="off" value="" class="layui-input">
							</div>
						</td>
					</tr>
				</table>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">
					<span class='x-red'>*</span>联系电话
				</label>
				<div class="layui-input-block">
					<input type="text" lay-verify="required|phone" oninput="value=value.replace(/[^\d]/g, '')" name="phone" id="phone" autocomplete="off" value="" class="layui-input">
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">
					<span class='x-red'>*</span>住址
				</label>
				<div class="layui-input-block">
					<input type="text" lay-verify="required" name="addr" id="addr" autocomplete="off" value="" class="layui-input">
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">
					<span class='x-red'>*</span>所属社区
				</label>
				<div class="layui-input-block">
					<select name="ascription" id="ascription">
						<option value="0">---请选择所属社区---</option>
						<option value="温泉社区">温泉社区</option>
						<option value="玉龙社区">玉龙社区</option>
						<option value="毛绢社区">毛绢社区</option>
						<option value="营胜村">营胜村</option>
						<option value="五龙背村">五龙背村</option>
						<option value="新建村">新建村</option>
						<option value="新康村">新康村</option>
						<option value="孙家村">孙家村</option>
					</select>
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">
					<span class='x-red'>*</span>类型
				</label>
				<div class="layui-input-block">
					<input type="radio" name="type" value="社会老人" title="社会老人" >
					<input type="radio" name="type" value="低保老人" title="低保老人" >
					<input type="radio" name="type" value="五保老人" title="五保老人" >
					<input type="radio" name="type" value="其他" title="其他" checked>
				</div>
			</div>
			<!--  <form class="layui-form layui-form-pane" action="" id="add">-->
			<fieldset class="layui-elem-field">
				<legend class="layui-font-14">联系人</legend>
				<div class="layui-field-box">
					<div class="layui-form-item">
						<table class="layui-hide" id="contacts", name="contacts" lay-filter="test"></table>
					</div>
				</div>
			</fieldset>
			<fieldset class="layui-elem-field">
				<legend class="layui-font-14">健康情况</legend>
				<div class="layui-field-box">
					<div class="layui-form-item">
						<fieldset class="layui-elem-field">
						  <legend class="layui-font-14">慢性病</legend>
						  <div class="layui-field-box">
							<div class="seach-box">
								<input type="checkbox" name="高血压" 		id="高血压" title="高血压">
								<input type="checkbox" name="高血糖" 		id="高血糖" title="高血糖"> 
								<input type="checkbox" name="冠心病" 		id="冠心病" title="冠心病">
								<input type="checkbox" name="哮喘" 			id="哮喘" title="哮喘">
								<input type="checkbox" name="通风" 			id="通风" title="通风">
								<input type="checkbox" name="慢性支气管炎" id="慢性支气管炎" title="慢性支气管炎">
								<input type="checkbox" name="慢性肝炎" 		id="慢性肝炎" title="慢性肝炎">
								<input type="checkbox" name="慢性贫血" 		id="慢性贫血" title="慢性贫血">
								<input type="checkbox" name="慢性关节炎" 	id="慢性关节炎" title="慢性关节炎">
								<input type="checkbox" name="慢性颈椎疼痛"	id="慢性颈椎疼痛" title="慢性颈椎疼痛">
								<input type="checkbox" name="其他" 			id="其他" title="其他">
							</div>
						  </div>
						</fieldset>
					</div>
					<div class="layui-form-item">
						<textarea name="healthdescription" placeholder="健康描述" class="layui-textarea"></textarea>
					</div>
				</div>
			</fieldset>
			<!--</form>-->
			<div class="layui-form-item">
				<textarea name="other" placeholder="其他" class="layui-textarea"></textarea>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">登记人</label>
				<div class="layui-input-block">
					<input type="text" id="registrant" disabled="disabled" name="registrant" autocomplete="off" value="" placeholder="空制在6个汉字，12个字符以内"
						   class="layui-input">
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">登记时间</label>
				<div class="layui-input-inline">
					<input type="text" class="layui-input" disabled="disabled" id="registrant_time" name="registrant_time" placeholder="yyyy-MM-dd">
				</div>
			</div>
			
			<div class="layui-form-item">
				<button class="layui-btn layui-btn-fluid"  type="button" lay-filter="add" lay-submit="">
					保存
				</button>
			</div>
		</div>
    </form>
</div>

<script type="text/html" id="fieldtool">
  <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="delete">删除</a>
</script>

<!--工具栏模板-->
<script type="text/html" id="contactstools">
  <div class="layui-btn-group">
    <button class="layui-btn layui-btn-primary layui-btn layui-btn-sm" id="contacts_add">
		<i class="layui-icon"  style="font-size: 20px">&#xe61f;</i>
	</button>
	<!--<button class="layui-btn layui-btn-primary layui-btn layui-btn-sm" onclick="onRefresh();" lay-event="refresh"><i class="layui-icon"  style="font-size: 20px">&#xe669;</i></button>-->
  </div>
</script>

<script>	
	
    layui.use(['element','layer','form','upload', 'table', 'laydate', 'laytpl'], function(){
        var  $ = layui.jquery;//jquery
        var lement = layui.element;//面包导航
        var layer = layui.layer;//弹出层
        var form = layui.form;
        var upload = layui.upload;
		var table = layui.table;
		var laydate = layui.laydate;
		var laytpl =layui.laytpl
		
		init(form, table);
		
		var local = layui.sessionData("client-list")
		console.log(local.modify)
		var avatar_tpl = avatar.innerHTML
		var avatar_div = document.getElementById('avatardiv')
		laytpl(avatar_tpl).render(local.modify, function(html){
			avatar_div.innerHTML = html;
		})
		
		if (local.modify["Avatar"] !== "") {
			console.log(AvatarPath+local.modify["Avatar"]+".jpg")
			$('#avatarImg').attr('src', AvatarPath+local.modify["Avatar"]+".jpg")
		}
		
		$.ajaxSetup({
			headers: {'Access-Control-Allow-Origin' : Domain,},
			xhrFields: {withCredentials: true},
		});
		upload.render({
			elem: '#test1'
			,url: BasePath + '/uploadavatar'
			,data: {idx: local.modify["Idx"]}
			,accept: 'images'
			,acceptMime:'image/jpg'
			,before: function(obj){
			  //预读本地文件示例，不支持ie8
			  obj.preview(function(index, file, result){
				$('#avatarImg').attr('src', result); //图片链接（base64）
			  });
			  
			  element.progress('demo', '0%'); //进度条复位
			  layer.msg('上传中', {icon: 16, time: 0});
			}
			,done: function(res){
			  //如果上传失败
			  if(res.code > 0){
				return layer.msg('上传失败');
			  }
			  $('#demoText').html(''); //置空上传失败的状态
			}
			//进度条
			,progress: function(n, elem, e){
			  element.progress('demo', n + '%'); //可配合 layui 进度条元素使用
			  if(n == 100){
				layer.msg('上传完毕', {icon: 1});
			  }
			}
		  });
		
		table.render({
			elem: '#contacts'
			,height: 270
			,data: JSON.parse(JSON.parse(local.modify["Contacts"]))
			,editTrigger: 'dblclick'
			,toolbar: '#contactstools'
			,cols: [[
				,{field:'id', width: '1%', align:'center', title: '序号', hide: true}
				,{field:'name', width: '24%', align:'center', edit: 'text', title: '姓名'}
				,{field:'phone', width: '40%', align:'center', edit: 'text', title: '联系电话'}
				,{field:'relationship', width: '25%', align:'center', edit: 'text', title: '关系'} 
				,{title: '操作', width: '10%', align:'center', toolbar: '#fieldtool', fixed: 'right'}
			]]
		});
		
		table.on('tool(test)', function(obj) {
			var data = obj.data;
			console.log(obj.event);
			
			if (obj.event === 'delete') {
				if (data.name == "") {
					var table_data = table.cache["contacts"];
					table_data.splice(obj.tr.data("index"), 1);
					table.reload("contacts", {data: table_data})
				} else {
					layer.confirm('确定要删除[' + data.name + ']么?',
						{btn:['确定', '取消']},
						function(index, layero) {
							var table_data = table.cache["contacts"];
							table_data.splice(obj.tr.data("index"), 1);
							table.reload("contacts", {data: table_data})
							layer.close(index);
						});
				}
			}
		});
		
		$(document).on('click', '#contacts_add', function(){			
			var table_data = table.cache["contacts"];
			table_data.push({
				"name": "",
				"phone": "",
				"relationship":""});
				
			table.reload("contacts", {data: table_data})
		});
		
		//初始赋值
		laydate.render({
			elem: '#registrant_time'
			,value: new Date()
			,isInitValue: true
		 });
		 
		 //鼠标失去焦点事件
        $(document).ready(function () {
            $("#chinaid").blur(function () {
                var china_id = $(this).val();
				console.log(china_id);
				var age = GetAge(china_id);
				if (age != 0) {
					$("#age").val(age);
				}
				document.getElementById("sex").value = GetSex(china_id);
				form.render("select");
            })
        });

        //监听提交
        form.on('submit(add)', function(data){
			data.field["idx"] = layui.sessionData("client-list").Modify["Idx"]
			
			var slow = [];
			var child = $(".seach-box input[type='checkbox']");
			console.log(child);
			child.each(function (index, item) {		
				if (item.checked) {
					slow.push(item.id);
				}
			});
			// 慢病
			console.log(slow);
			data.field["slow"] = JSON.stringify(slow);
			// 联系人
			data.field["contacts"] = JSON.stringify(table.cache["contacts"]);
			console.log(data.field);
			var obj = JSON.parse(data.field["contacts"])
			console.log(obj)
			
			console.log(data.field)
			return;
			
            $.ajax({
                type: "post",
                url: BasePath + '/register',
                data: data.field,
                dataType: "json",
				headers: {'Access-Control-Allow-Origin' : 'http://localhost',},
				xhrFields: {withCredentials: true},
                success: function(data){
					console.log(data)
                    if(data.code==0){
                        layer.msg("注册成功", {icon: 6,time:2000},function () {
                            window.parent.location.reload();
                            var index = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index);
                        });
                        return false;
                    }else if(data.code==1001) {
						// cookie 失效
						var from = document.getElementById("from").value;
						if (from == "client-list") {
							parent.parent.location.href = "../index.html";
						} else {
							parent.location.href = "../index.html";
						}
                        return false;
					}else{
                        layer.msg(data.msg,{icon:5,time:5000});
						return false;
                    }
                }
            });
        });

    })
</script>
<script>
	function init(form, table) {
		var local = layui.sessionData("client-list")
		local.modify["AvatarPath"] = "";
		if (local.modify["Avatar"] !== "") {
			local.modify["AvatarPath"] = BasePath + '/avatarphoto/' + local.modify["Avatar"] + '.jpg'
		}
		
		var slows = JSON.parse(JSON.parse(local.modify["SlowIll"]))
		form.val("modify", {
			"name": local.modify["Name"],
			"chinaid": local.modify["ChinaId"],
			"sex": GetSex(local.modify["ChinaId"]),
			"age": GetAge(local.modify["ChinaId"]),
			"phone": local.modify["Phone"],
			"addr": local.modify["Addr"],
			"type": local.modify["Type"],
			"ascription": local.modify["Community"],
			"高血压": slows.includes("高血压"),
			"高血糖": slows.includes("高血糖"),
			"冠心病": slows.includes("冠心病"),
			"哮喘": slows.includes("哮喘"),
			"通风": slows.includes("通风"),
			"慢性支气管炎": slows.includes("慢性支气管炎"),
			"慢性肝炎": slows.includes("慢性肝炎"),
			"慢性贫血": slows.includes("慢性贫血"),
			"慢性关节炎": slows.includes("慢性关节炎"),
			"慢性颈椎疼痛": slows.includes("慢性颈椎疼痛"),
			"其他": slows.includes("其他"),
			"healthdescription": local.modify["Healthy"],
			"other": local.modify["Remarks"],
			"registrant": local.modify["Handler"],
			"registrant_time": local.modify["RegisterTime"],
		});
	}

</script>

</body>
</html>