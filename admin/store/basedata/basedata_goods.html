<!DOCTYPE html>
<html class="x-admin-sm">
<head>
    <meta charset="utf-8">
    <title>
        商品信息
    </title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../../css/font.css">
    <link rel="stylesheet" href="../../css/index.css">
    <link rel="stylesheet" href="../../lib/dtree/dtree.css">
    <link rel="stylesheet" href="../../lib/dtree/font/dtreefont.css">
    <link rel="stylesheet" href="../css/table.css">
    <script src="../../lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../js/index.js"></script>
    <script type="text/javascript" src="../../../js/base.js"></script>
</head>
<body>

    <div class="x-nav">
        <span class="layui-breadcrumb">
            <a href="">首页</a>
            <a href="">库房管理</a>
            <a href="">基本资料</a>
            <a>
            <cite>商品信息</cite></a>
        </span>
        <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right" onclick="location.reload()" title="刷新">
            <i class="layui-icon layui-icon-refresh" style="line-height:30px"></i>
        </a>
    </div>

    <div class="layui-card">
        <div class="layui-row layui-col-space5">
            
            <div class="layui-col-xs3 layui-col-sm3 layui-col-md3">
                <div class="layui-card">
                    <div class="layui-row">
                        <div class="layui-card-body">
                            <ul id="good_class" class="dtree" data-id="0"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="layui-col-xs9 layui-col-sm9 layui-col-md9">
                <div class="layui-card">
                    <table class="layui-hide" id="good_table" lay-filter="good_table_filter"></table>
                </div>
                

                <div class="layui-card">
                    <div class="layui-form layui-form-pane layui-hide layui-anim" id="form_add" lay-filter="filter-test-layer" style="margin: 16px;">
                        <hr class="layui-border-green">
                        <div class="demo-login-container">
                            <div class="layui-form-item">
                                <div class="layui-input-wrap">
                                    <!-- 表单行，用于输入商品名称和选择商品类别 -->
                                    <div class="layui-row layui-col-space5">
                                        <!-- 商品名称输入框 -->
                                        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                                            <div class="layui-form-label">	
                                                <!-- 必填项提示 -->
                                                <span class='x-red'>*</span>商品名称
                                            </div>
                                            <div class="layui-input-block">
                                                <!-- 商品名称输入字段，必填 -->
                                                <input type="text" id="name" name="name" lay-verify="required" autocomplete="off" value="" class="layui-input">
                                            </div>
                                        </div>
                                        <!-- 商品类别选择区域 -->
                                        <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                                            <label class="layui-form-label">类别</label>
                                            <!-- 输入规格名称的文本框 -->
                                            <div class="layui-input-block">
                                                <input type="text" name="classname" id="classname" autocomplete="off" value="" class="layui-input" disabled>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                
                            <div class="layui-form-item" >
                                <!-- 表单行，用于输入品牌和规格信息 -->
                                <div class="layui-row layui-col-space5">
                                    <!-- 品牌输入框 -->
                                    <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                                        <div class="layui-form-label">品牌</div>
                                        <!-- 输入品牌名称的文本框 -->
                                        <div class="layui-input-block">
                                            <input type="text" id="brand" name="brand" autocomplete="off" value="" class="layui-input">
                                        </div>
                                    </div>
                                    <!-- 规格输入框 -->
                                    <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                                        <label class="layui-form-label">规格</label>
                                        <!-- 输入规格名称的文本框 -->
                                        <div class="layui-input-block">
                                            <input type="text" name="specification" id="specification" autocomplete="off" value="" class="layui-input">
                                        </div>
                                    </div>
                                </div>
                            </div>
                
                            <div class="layui-form-item">
                                <!-- 单位输入字段，作为表单的一部分 -->
                                <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                                    <!-- 标签显示单位字段的必要性 -->
                                    <div class="layui-form-label">	
                                        <span class='x-red'>*</span>单位
                                    </div>
                                    <!-- 输入框用于用户输入单位信息 -->
                                    <div class="layui-input-block">
                                        <input type="text" id="unit" name="unit" lay-verify="required" autocomplete="off" value="" class="layui-input">
                                    </div>
                                </div>
                            </div>
                
                            <div class="layui-form-item">
                                <label class="layui-form-label">连续新增</label>
                                <div class="layui-input-block">
                                    <input type="checkbox" checked id="open" lay-skin="switch" lay-filter="switchTest" title="开|关">
                                </div>
                            </div>
                
                            <!-- 隐藏字段区域，用于存储拼音和首字母 -->
                            <div class="layui-form-item">
                                <!-- 类名称的分类，隐藏输入框，用于后续的拼音检索或排序 -->
                                <input type="text" id="class" name="class" value="" class="layui-input" style="display:none;">
                                <!-- 类名称的拼音字段，隐藏输入框，用于后续的拼音检索或排序 -->
                                <input type="text" id="pinyin" name="pinyin" value="" class="layui-input" style="display:none;">
                                <!-- 类名称的首字母字段，隐藏输入框，用于首字母快速检索 -->
                                <input type="text" id="pinyinFirst" name="pinyinFirst" value="" class="layui-input" style="display:none;">
                            </div>
                            <div class="layui-form-item"></div>
                            <div class="layui-form-item"></div>
                            <div class="layui-form-item"></div>
                            <div class="layui-form-item"></div>
                            <div class="layui-form-item"></div>
                
                            <!-- 表单提交区域 -->
                            <div class="layui-form-item">
                                <!-- 使用Flex布局，确保表单在不同屏幕尺寸下都有良好的展示效果 -->
                                <div class="layui-row layui-col-space10">
                                    <!-- 主要内容区域，预留占位，后续可根据需求添加表单元素 -->
                                    <div class="layui-col-xs9 layui-col-sm9 layui-col-md9"></div>
                                    <!-- 提交按钮区域 -->
                                    <div class="layui-col-xs2 layui-col-sm2 layui-col-md2">
                                        <!-- 提交按钮，使用layui-btn-radius和layui-btn-normal样式定义按钮形状和颜色，通过lay-submit和lay-filter属性启用表单提交功能 -->
                                        <button class="layui-btn layui-btn-radius layui-btn-normal layui-btn-fluid" lay-submit lay-filter="add"">保存</button>
                                    </div>
                                    <!-- 取消按钮区域 -->
                                    <div class="layui-col-xs1 layui-col-sm1 layui-col-md1">
                                        <!-- 取消按钮，通过onclick事件绑定到函数onExit，用于取消操作 -->
                                        <button class="layui-btn layui-btn-radius layui-btn-normal layui-btn-fluid" type="button" onclick="onExit();">取消</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--工具栏模板-->
    <script type="text/html" id="goodlisttools">
        <div class="layui-btn-container">
            <button class="layui-btn layui-btn-sm" onclick="onAddGood();" lay-event="add">
                <i class="layui-icon">&#xe61f;</i>新增
            </button>
        </div>
    </script>

    <script type="text/html" id="fieldtool">
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="delete">删除</a>
    </script>

<script>

    var good_table;
    var good_table_where = {};
    layui.extend({
        dtree: '{/}../../lib/dtree/dtree',   // {/}的意思即代表采用自有路径，即不跟随 base 路径
        pinyin: '{/}../../lib/pinyin/pinyin'   // {/}的意思即代表采用自有路径，即不跟随 base 路径
    }).use(['dtree', 'table', 'jquery', 'layer', 'form', 'pinyin'], function()  {
        var dtree = layui.dtree;
        var table = layui.table
        var layer = layui.layer;
        var form = layui.form;
        var pinyin = layui.pinyin;
        var  $ = layui.jquery;  //jquery

        $.ajaxSetup({
			headers: {'Access-Control-Allow-Origin' : Domain,},
            xhrFields: {withCredentials: true},
        });

        var DTree = dtree.render({
            elem: "#good_class",
            url: BasePathStore + "/getgoodclass",
            withCredentials: true,
            line: true,
            height: "full-70",
            width: "240",
            dataFormat: "list",
            dataStyle: "layuiStyle",
            toolbar: true, 
            toolbarStyle: {title:"节点", area: ["60%", "40%"]},
            toolbarWay:"fixed",
            toolbarFun: {
                loadToolbarBefore: function(buttons, param, $div){
                    if(param.parentId === "0"){ // 如果是根节点
                        buttons.editToolbar = "";  // 取消修改功能
                        buttons.delToolbar = "";  // 取消删除功能
                    }
                    return buttons; // 将按钮对象返回
                },
                addTreeNode: function(treeNode, $div){
                    $.ajax({
                        type: "post",
                        data: treeNode,
                        dataType: "json",
                        headers: {'Access-Control-Allow-Origin' : Domain,},
                        xhrFields: {withCredentials: true},
                        url: BasePathStore + "/addgoodclass",
                        success: function(result){
                            if (result.code == DTree.response.statusCode) {
                                layer.msg("添加成功");
                                DTree.changeTreeNodeAdd(JSON.stringify(treeNode));
                            } else {
                                layer.msg(result.msg);
                                DTree.changeTreeNodeAdd(false);
                            }
                        }
                    });
                },
                delTreeNode: function(treeNode, $div){
                    $.ajax({
                        type: "post",
                        data: treeNode,
                        dataType: "json",
                        headers: {'Access-Control-Allow-Origin' : Domain,},
                        xhrFields: {withCredentials: true},
                        url: BasePathStore + "/delgoodclass",
                        success: function(result){
                            if (result.code == DTree.response.statusCode) {
                                DTree.changeTreeNodeDel(true);
                            } else {
                                layer.msg(result.msg);
                                DTree.changeTreeNodeDel(false); // 删除失败
                            }
                        }
                    });
                },
                editTreeNode: function(treeNode, $div){
                    var data = {}
                    data.nodeId = treeNode.nodeId;
                    data.nodeName = treeNode.context;

                    $.ajax({
                        type: "post",
                        data: data,
                        dataType: "json",
                        headers: {'Access-Control-Allow-Origin' : Domain,},
                        xhrFields: {withCredentials: true},
                        url: BasePathStore + "/modifygoodclass",
                        success: function(result){
                            if (result.code == DTree.response.statusCode) {
                                layer.msg("修改成功");
                                DTree.changeTreeNodeEdit(true);
                            } else {
                                layer.msg(result.msg);
                                DTree.changeTreeNodeEdit(false);
                            }
                        }
                    });
                }
            }
        });

        // 点击节点名称获取选中节点值
        dtree.on("node('good_class')" ,function(obj){
            
            let where = {}
            if (obj.param.nodeId !== "001") {
                where.class = obj.param.nodeId
            }
            
            good_table = layui.table.reload('good_table', { where: where })

            node = getSelectNodeId()
            if (Object.keys(node).length != 0 && node.parentId != "0") {
                document.getElementById("class").value = node.nodeId;
                document.getElementById("classname").value = node.context;
            }
        });

        good_table = table.render({
            elem: '#good_table'
            ,height: function() {
                var oh = $('#form_add').outerHeight();
                oh = $('#form_add').hasClass('layui-hide') ? 0 : oh
                return $(window).height() - oh - 80;
            }
            ,url: BasePathStore + '/getgoods'	
            ,data: []
            ,method: 'post'
            ,page: true //开启分页
            ,toolbar: '#goodlisttools'//'default' //开启工具栏，此处显示默认图标，可以自定义模板，详见文档
            ,defaultToolbar: ['filter', 'exports', 'print']
            ,even: true
            ,cellMinWidth: 100 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            ,id:"good_table"
            ,title:"列表"
            ,limits:[10,20,30,50,100,150,200,300,400,500,1000]
            ,limit: 20
            ,className:"layui-table-testcss"
            ,cols: [[
                {field:'name', title: '名称', align:'center', minWidth: 100, width: '14%', fixed: 'left'}
                ,{field:'id', title: '编号', align:'center', minWidth: 180, width: '10%', hide: true}
                ,{field:'class', title: '类别', align:'center', width: '10%'}
                ,{field:'unit', title: '单位', align:'center', width: '10%'}
                ,{field:'brand', title: '品牌', align:'center', width: '20%'}
                ,{field:'specification', title: '规格', align:'center', width:'25%'}
                //,{title: '操作', align:'center', toolbar: '#fieldtool', minWidth: 150, width: '10%', fixed: 'right'}
            ]]
            ,parseData: function(res){ //res 即为原始返回的数据
                if (res.code == 0) {

                    list = [];
                    var idx = 1;
                    for(var tableitem of res.data) {
                        data = {};
                        data.name = tableitem[1]
                        data.id = tableitem[0]
                        data.class = tableitem[9]
                        data.unit = tableitem[7]
                        data.brand = tableitem[5]
                        data.specification = tableitem[6]
                        //data.LAY_CHECKED = (++idx % 2 == 0) ? true : false;
                        list.push(data);
                    }

                    return {
                        "code": res.code, //解析接口状态
                        "msg": res.message, //解析提示文本
                        "count": res.count, //解析数据长度
                        "data": list //解析数据列表
                    };
                }
                if (res.code == 1001) {
                    window.top.location.href = "../../../index.html";
                }

                return {
                    "code": res.code, //解析接口状态
                    "msg": res.message, //解析提示文本
                    "count": res.count, //解析数据长度
                    "data": [] //解析数据列表
                };
            }
            ,done: function(res, curr, count){

            }
            
        });

        $(document).ready(function () {
            $("#name").blur(function () {
                var name = $(this).val();
                
                var pinyinstr = pinyin.ConvertPinyin(name);
                document.getElementById("pinyin").value = pinyinstr;

                var pinyinFirst = pinyin.makePy(name)[0];
                document.getElementById("pinyinFirst").value = pinyinFirst;
            })
        });

        form.on('submit(add)', function(data){
            var loading_idx = layer.load(2);
            $.ajax({
                type: "post",
                data: JSON.stringify(data.field),
                dataType: "json",
                headers: {'Access-Control-Allow-Origin' : Domain, "Content-Type": "application/json"},
                xhrFields: {withCredentials: true},
                url: BasePathStore + "/addgood",
                success: function(result) {

                    layer.close(loading_idx);

                    if (result.code == 0) {
                        // 获取open checked状态
                        var open = $("#open").prop("checked");
                        if (open) {
                            // 清空name
                            $("#name").val("");
                            good_table.reload();
                        } else {
                            onExit();
                        }
                        layer.msg("添加成功");
                    } else {
                        layer.msg(result.msg);
                    }
                },
            });
            return false; // 阻止表单跳转
        });
    });


    function onAddGood() {
        node = getSelectNodeId()
        if (Object.keys(node).length == 0 || node.parentId == "0") {
            layer.msg("请选择一个分类");
            return;
        }


        document.getElementById("form_add").classList.remove("layui-hide");

        // 移除添加店铺表单的向上动画类
        layui.$('#form_add').removeClass('layui-anim-up')
        // 延迟执行，添加向上滑入的动画类
        setTimeout(function(){
            layui.$('#form_add').addClass('layui-anim-up'); // 给目标元素追加「往下滑入」的动画
        });
    }


    /**
     * 刷新商品列表
     */
    function reloadTable() {
        layui.table.reload('good_table', { where: {} })
    }

    /**
     * 获取Dtree当前选中的节点
     */
    function getSelectNodeId() {
        return layui.dtree.getNowParam("good_class");
     }

    /**
     * 当用户退出某个特定操作时触发的函数。
     * 该函数主要负责隐藏添加表单的界面，并重新加载商品列表表格以更新显示。
     */
    function onExit() {
        document.getElementById("form_add").classList.add("layui-hide");
        good_table.reload();
    }
</script>


</body>
</html>