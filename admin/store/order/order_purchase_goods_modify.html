<!DOCTYPE html>
<html class="x-admin-sm">
    <head>
        <meta charset="utf-8">
        <title>
            入库单-添加商品
        </title>
        <!-- 设置浏览器渲染引擎为Webkit，以确保页面在各种浏览器中的一致性 -->
        <meta name="renderer" content="webkit">
        <!-- 指定IE浏览器使用最新的渲染模式，支持HTML5和CSS3等特性 -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <!-- 控制移动设备的视口大小和缩放，优化移动浏览体验 -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- 引入自定义字体文件，用于页面中的特殊字体展示 -->
        <link rel="stylesheet" href="../../css/font.css">
        <!-- 引入页面的主样式表，定义页面的布局和样式 -->
        <link rel="stylesheet" href="../../css/index.css">
        <!-- 引入dtree的样式文件，用于展示目录树结构 -->
        <link rel="stylesheet" href="../../lib/dtree/dtree.css">
        <!-- 引入dtree的字体文件，用于dtree中的图标显示 -->
        <link rel="stylesheet" href="../../lib/dtree/font/dtreefont.css">
        <!-- 引入layui库的JavaScript文件，用于页面的组件和功能支持 -->
        <script src="../../lib/layui/layui.js" charset="utf-8"></script>
        <!-- 引入页面的JavaScript文件，包含页面交互逻辑和功能实现 -->
        <script type="text/javascript" src="../../js/index.js"></script>
        <!-- 引入基础的JavaScript文件，可能包含一些全局的工具函数和配置 -->
        <script type="text/javascript" src="../../../js/base.js"></script>
        <!-- 引入外部CSS文件，用于定制表格的样式 -->
        <link rel="stylesheet" href="../css/table.css">
        <style>
            html,
             body {
                width: 100%;
                height: 90%;
            } 
        
            .chosen-area {
                display: inline-block;
                width: 100%;
                min-height: 30px;
                border: 1px solid #cccccc;
                line-height: 100%;
                box-sizing: border-box;
                padding: 0px 1px;
                background-color: rgb(255, 255, 255);
            }
        
            .chosen-area span {
                font-size: 13px;
                color: #000;
            }
        
            .chosen-area:hover {
                border: 1px solid #16baaa;
                cursor: pointer;
            }

            .disabled-chosen-area {
                pointer-events: none; /* 禁止点击 */
                opacity: 0.6;         /* 半透明效果 */
                cursor: not-allowed;  /* 禁用光标 */
            }
        </style>
        <style>
            body{padding:10px; font-size:14px; background:#fff; width:95%; margin:0 auto; font-size:14px; line-height:20px; overflow:hidden;}
            /* p{margin-bottom:10px;} */
            input{border:1px solid #999; padding:5px 10px; }
        </style>

    </head>

    <body>
        <div class="layui-form layui-form-pane" lay-filter="filter-test-layer">
            <div class="demo-login-container">
                <div class="layui-form-item">
                    <div class="layui-form-label">	
                        <!-- 必填项提示 -->
                        <span class='x-red'>*</span>商品名称
                    </div>
                    <div class="layui-input-block">
                        <!-- 商品名称输入字段，必填 -->
                        <input type="hidden" id="goods_name" name="goods_name" lay-verify="required" autocomplete="off" value="" class="layui-input">
                        <a class="disabled-chosen-area" id="goods_select" name="goods_select"></a>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-form-label">	
                        <span class='x-red'>*</span>类别
                    </div>
                    <div class="layui-input-block">
                        <!-- 单位输入字段，必填 -->
                        <input type="text" id="class" name="class" autocomplete="off" value="" class="layui-input" disabled>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-form-label">	
                        <span class='x-red'>*</span>单位
                    </div>
                    <div class="layui-input-block">
                        <!-- 单位输入字段，必填 -->
                        <input type="text" id="unit" name="unit" lay-verify="number" autocomplete="off" value="" class="layui-input" disabled>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-form-label">	
                        <span class='x-red'>*</span>单价
                    </div>
                    <div class="layui-input-block">
                        <!-- 单价输入字段，必填 -->
                        <input type="text" id="price" name="price" placeholder="￥" autocomplete="off" value="" class="layui-input" onblur="onInputPrice()">
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-form-label">	
                        <span class='x-red'>*</span>数量
                    </div>
                    <div class="layui-input-block">
                        <!-- 数量输入字段，必填 -->
                        <input type="text" id="count" name="count" autocomplete="off" value="" class="layui-input" onblur="onInputCount()">
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-form-label">	
                        优惠前总价
                    </div>
                    <div class="layui-input-block">
                        <!-- 总价输入字段，必填 -->
                        <input type="text" id="amount_bd" name="amount_bd" placeholder="￥" autocomplete="off" value="" class="layui-input" disabled>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-form-label">优惠</div>
                    <div class="layui-input-block">
                        <!-- 总价输入字段，必填 -->
                        <input type="text" id="discount" name="discount" placeholder="￥" autocomplete="off" value="" class="layui-input" onblur="onInputDiscount()">
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-form-label">总价</div>
                    <div class="layui-input-block">
                        <!-- 总价输入字段，必填 -->
                        <input type="text" id="amount" name="amount" placeholder="￥" autocomplete="off" value="" class="layui-input" disabled>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-form-label">备注</div>
                    <div class="layui-input-block">
                        <textarea id="remark" name="remark" placeholder="备注" class="layui-textarea" onblur="onInputRemark()"></textarea>
                    </div>
                </div>

                <!-- <div class="layui-form-item">
                    <div class="layui-form-label">	
                        取整处理
                    </div>
                    <div class="layui-input-block">
                        <input type="text" id="handle" name="handle" autocomplete="off" value="" class="layui-input" disabled>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">取整处理</label>
                    <div class="layui-input-block">
                        <input type="checkbox" checked id="open" lay-skin="switch" lay-filter="switchTest" title="开|关">
                    </div>
                </div>  -->

                <input type="hidden" id="goods_info" name="goods_info" autocomplete="off" value="" class="layui-input" disabled>
            </div>
        </div>
    </body>

    <script>

        layui.config({
            base: '../../../layui-exts'
        }).extend({
            'dropdownTable': '/dropdownTable/dropdownTable'
        });

        const params = new URLSearchParams(window.location.search);
        let goods_info = JSON.parse(params.get('goods'))

        layui.use(['form', 'layer', 'dropdownTable', 'jquery'], function(){
            var form = layui.form
            ,layer = layui.layer
            ,dropdownTable = layui.dropdownTable
            ,$ = layui.jquery;

            document.getElementById('price').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    this.blur();
                    document.getElementById('count').focus();
                }
            });

            document.getElementById('count').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    this.blur();
                    document.getElementById('discount').focus();
                }
            });

            document.getElementById('discount').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    this.blur();
                    document.getElementById('remark').focus();
                }
            });

            initData()

            $.ajaxSetup({
                headers: {'Access-Control-Allow-Origin' : Domain,},
                xhrFields: {withCredentials: true},
            });

            var dropdown_table_goodsSelect_select = { 
                style:'padding:10px;width:80%;height:80%',
                emptyMsg: ' ',  
                id: "goodsSelect",
                elem: "#goods_select",
                bindInput: "#goods_name",
                auxiliaryType: "search",
                searchName: "custom",
                badgeStyle: "margin:1px 1px;font-size:12px;padding:4px 6px;width:80%;height:90%;",
                selectType: 'radio',
                selectTable: {
                    id:"select_table",
                    uniqueId: 'name',
                    displayField: 'name',
                    cols: [[
                        {field:'name', title: '名称', align:'center', minWidth: 100, width: '14%', fixed: 'left'}
                        ,{field:'id', title: '编号', align:'center', minWidth: 180, width: '10%', hide: true}
                        ,{field:'class', title: '类别', align:'center', width: '10%'}
                        ,{field:'unit', title: '单位', align:'center', width: '10%'}
                        ,{field:'brand', title: '品牌', align:'center', width: '20%'}
                        ,{field:'specification', title: '规格', align:'center', width:'25%'}
                    ]],
                }
            }
            dropdownTable.render(dropdown_table_goodsSelect_select);

        });

        function initData() {
            console.log("init data:", goods_info)
            $('#goods_name').attr('data-display-value', goods_info.name);
            $('#goods_name').attr('value', goods_info.id);

            document.getElementById("unit").value = goods_info.unit;
            document.getElementById("class").value = goods_info.class;
            document.getElementById("price").value = goods_info.price;
            document.getElementById("count").value = goods_info.count;
            document.getElementById("amount_bd").value = goods_info.amount_bd;
            document.getElementById("discount").value = goods_info.discount;
            document.getElementById("amount").value = goods_info.amount;
            document.getElementById("remark").value = goods_info.remark;
            document.getElementById("goods_info").value = JSON.stringify(goods_info);
        }

        /**
         * 验证值是否符合指定类型的要求
         * 
         * @param {string} type - 要验证的类型，可以是"price"或"number"
         * @param {string} value - 要验证的值
         * @returns {boolean} - 如果值符合指定类型的正则表达式，则返回true，否则返回false
         */
        function VerifyValue(type, value) {
            // 定义一个空字符串用于存储正则表达式
            let regex = ""

            // 根据传入的类型设置不同的正则表达式
            switch (type) {
                case "price":
                    // 价格格式，可能包含逗号分隔的千位数和最多两位小数点后的数字
                    regex = /^-?\d{1,3}(,\d{3})*(\.\d{1,2})?$/; ///^\+?[1-9]\d*$/; 
                    break;
                case "number":
                    // 纯数字格式
                    regex = /^\d+$/;
                    break;
                default:
                    // 如果类型不是"price"或"number"，返回false
                    return false;
            }

            // 使用正则表达式测试传入的值，如果匹配则返回true，否则返回false
            return regex.test(value)
        }

        function onInputPrice() {
            var dom = document.getElementById("price");
            var price = dom.value;
            console.log(price)
            if (price == "") {
                return;
            }
            
            if (!VerifyValue("price", price)) {
                console.log("VerifyValue price", price)
                layui.layer.tips('请输入正确的价格', dom, {
                    tips: [1, '#16b777']
                });
                dom.value = ""
                return;
            }

            price = Number(price).toFixed(2)
            dom.value = price
            goods_info.price = price;

            computeTotlePrice();
            resetBack();
        }

        function onInputCount() {
            var dom = document.getElementById("count");
            var count = dom.value;

            if (count == "") {
                return;
            }

            if (!VerifyValue("number", count)) {
                layui.layer.tips('请输入正确的数量', dom, {
                    tips: [1, '#16b777']
                });
                dom.value = ""
                return;
            }
            goods_info.count = count;
            computePrice();
            resetBack();
        }

        function onInputDiscount() {
            var dom = document.getElementById("discount");
            var value = dom.value;

            if (value == "") {
                return;
            }

            if (!VerifyValue("price", value)) {
                layui.layer.tips('请输入正确的优惠价格', dom, {
                    tips: [1, '#16b777']
                });
                dom.value = ""
                return;
            }

            goods_info.discount = Number(value)
            
            var amount_bd_str = document.getElementById("amount_bd").value
            if (amount_bd_str == "") {
                return;
            }

            goods_info.amount_bd = Number(amount_bd_str)
            var amount = (goods_info.amount_bd - goods_info.discount)
            goods_info.amount = amount
            document.getElementById("amount").value = amount.toFixed(2)
            resetBack();
        }

        function onInputRemark() {
            goods_info.remark = document.getElementById("remark").value;
            resetBack();
        }

        function computeTotlePrice() {
            goods_info.count = goods_info.count ?? 0;
            if (Number(goods_info.price) == 0 || Number(goods_info.count) == 0) {
                return;
            }

            var amount_bd = Number(goods_info.price) * Number(goods_info.count);
            goods_info.amount_bd = amount_bd
            document.getElementById('amount_bd').value = amount_bd.toFixed(2);

            var discount = Number(document.getElementById('discount').value) ?? 0;
            goods_info.amount = amount_bd - discount
            goods_info.discount = discount
            document.getElementById('amount').value = (amount_bd - discount).toFixed(2)
        }

        function computePrice() {
            var amount = goods_info.amount ?? 0;
            amount = Number(amount) 

            var price = goods_info.price ?? 0;
            price = Number(price)

            if (amount == 0 && price == 0) {
                return;
            }

            computeTotlePrice();
        }

        function resetBack() {
            let goods_info_json = JSON.stringify(goods_info);
            document.getElementById("goods_info").value = goods_info_json;
        }

        function VerifyForm() {
            console.log("VerifyForm")
            return false;
        }

    </script>
</html>
