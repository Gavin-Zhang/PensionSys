<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>
        新建工单
    </title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">

    <link rel="stylesheet" href="./css/font.css">
    <link rel="stylesheet" href="./css/index.css">
    <script src="./lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="./js/index.js"></script>
	<script type="text/javascript" src="../js/base.js"></script>

    <!--<style>
        .imgs{display: none;}
        .picture{display: none;}
    </style>-->

    <!--百度编辑器
    <script src="./ueditor/ueditor.config.js"></script>
    <script src="./ueditor/ueditor.all.min.js"></script>
    <script src="./ueditor/lang/zh-cn/zh-cn.js"></script>
	-->
<style type="text/css">

</style>
</head>
<body>
<div class="layui-fluid">
		<form class="layui-form layui-form-pane" id="orderadd" lay-filter="orderadd">
			<div class="layui-form-item">
				<div class="layui-row">
					<div class="layui-col-xs10 layui-col-sm10 layui-col-md10">
						<label for="name" class="layui-form-label">
							<span class="x-red">*</span>老人</label>
						<div class="layui-input-block">
							<input type="text" id="name" name="name" required="" disabled="disabled" class="layui-input">
						</div>
					</div>
					<div class="layui-col-xs2 layui-col-sm2 layui-col-md2">
						<button class="layui-btn layui-btn-normal" type="button" onclick="onSelClient();">
							<i class="layui-icon">&#xe615;</i>
						</button>
					</div>
				</div>
			</div>
			<div class="layui-form-item">
				<div class="layui-row layui-col-space5">
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
						<label for="phone" class="layui-form-label">
							<span class="x-red">*</span>联系方式
						</label>
						<div class="layui-input-block">
							<input type="text" id="phone" name="phone" lay-verify="number" required="" class="layui-input">
						</div>
					</div>
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
						<label class="layui-form-label">
							<span class='x-red'>*</span>所属社区
						</label>
						<div class="layui-input-block">
							<select name="ascription" id="ascription">
								<option value="0">---请选择所属社区---</option>
								<option value="温泉社区">温泉社区</option>
								<option value="玉龙社区">玉龙社区</option>
								<option value="毛绢社区">毛绢社区</option>
								<option value="营胜村">营胜村</option>
								<option value="五龙背村">五龙背村</option>
								<option value="新建村">新建村</option>
								<option value="新康村">新康村</option>
								<option value="孙家村">孙家村</option>
							</select>
						</div>
					</div>
				</div>
			</div>
			<div class="layui-form-item">
				<label for="addr" class="layui-form-label">
					<span class="x-red">*</span>地址</label>
				<div class="layui-input-block">
					<input id="addr" name="addr" required="" autocomplete="off" class="layui-input">
				</div>
			</div>
			<div class="layui-form-item">
				<div class="layui-row layui-col-space1">
					<div class="layui-col-xs4 layui-col-sm4 layui-col-md4">
						<div class="layui-col-xs10 layui-col-sm10 layui-col-md10">
							<label for="service" class="layui-form-label">
								<span class="x-red">*</span>服务项目</label>
							<div class="layui-input-block">
								<input type="text" id="service" name="service" required="" disabled="disabled" class="layui-input">
							</div>
						</div>
						<div class="layui-col-xs2 layui-col-sm2 layui-col-md2">
							<button class="layui-btn layui-btn-normal" type="button" onclick="onSelService();">
								<i class="layui-icon">&#xe615;</i>
							</button>
						</div>
					</div>
					<div class="layui-col-xs4 layui-col-sm4 layui-col-md4">
						<label for="charge" class="layui-form-label">
							<span class="x-red">*</span>收费</label>
						<div class="layui-input-block">
							<input type="text" id="charge" name="charge" required="" disabled="disabled" class="layui-input">
						</div>
					</div>
					<div class="layui-col-xs4 layui-col-sm4 layui-col-md4">
						<label for="servicetime" class="layui-form-label"><span class="x-red">*</span>预约时间</label>
						<div class="layui-input-block">
							<input type="text" class="layui-input" id="servicetime">
						</div>
					</div>
				</div>
			</div>
			<div class="layui-form-item">
				<div class="layui-row layui-col-space5">
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
						<div class="layui-col-xs10 layui-col-sm10 layui-col-md10">
							<label for="waiter" class="layui-form-label">
								<span class="x-red">*</span>服务人员</label>
							<div class="layui-input-block">
								<input type="text" id="waiter" name="waiter" required="" disabled="disabled" class="layui-input">
							</div>
						</div>
						<div class="layui-col-xs2 layui-col-sm2 layui-col-md2">
							<button class="layui-btn layui-btn-normal" onclick="onSelWaiter();" lay-event="seclectw">
								<i class="layui-icon">&#xe615;</i>
							</button>
						</div>
					</div>
					<div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
						<label for="waiterphone" class="layui-form-label"><span class="x-red">*</span>联系电话</label>
						<div class="layui-input-block">
							<input type="text" class="layui-input" id="waiterphone">
						</div>
					</div>
				</div>
			</div>
			<div class="layui-form-item">
				<label for="handler" class="layui-form-label">
					<span class="x-red">*</span>办理人</label>
				<div class="layui-input-block">
					<input id="handler" name="handler" required="" lay-verify="handler" autocomplete="off" class="layui-input">
				</div>
			</div>
			<div class="layui-form-item">
				<textarea id="remarks" name="remarks" placeholder="备注" class="layui-textarea"></textarea>
			</div>
			<!--
			<div class="layui-form-item">
				<div class="layui-row layui-col-space1">
					<div class="layui-col-md6">
						<div class="layui-col-xs10 layui-col-sm10 layui-col-md10">
							<label for="service" class="layui-form-label">
								<span class="x-red">*</span>服务项目</label>
							<div class="layui-input-block">
								<input type="text" id="service" name="service" required="" disabled="disabled" class="layui-input">
							</div>
						</div>
						<div class="layui-col-xs2 layui-col-sm2 layui-col-md2">
							<button class="layui-btn layui-btn-normal" onclick="onSelService();" lay-event="seclects">
								<i class="layui-icon">&#xe615;</i>
							</button>
						</div>
					</div>
					<div class="layui-col-md6">
						<label for="service" class="layui-form-label">
							<span class="x-red">*</span>服务时长</label>
							<div class="layui-input-block">
								<input class="layui-input" type="number" name="num" data-step="1" 
								data-maxvalue="20" 
								data-minvalue="1" 
								lay-verify="required" 
								placeholder="小时"
								autocomplete="off" >
							</div>
					</div>
				</div>
			</div>
			-->
			<div class="layui-form-item">
				<button class="layui-btn layui-btn-fluid" lay-filter="add" lay-submit="">创建</button>
			</div>
		</form>
</div>

<script type="text/html" id="fieldtool">
  <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="delete">删除</a>
</script>

<!--工具栏模板-->
<script type="text/html" id="contactstools">
  <div class="layui-btn-group">
    <button class="layui-btn layui-btn-primary layui-btn layui-btn-sm" id="contacts_add">
		<i class="layui-icon"  style="font-size: 20px">&#xe61f;</i>
	</button>
	<!--<button class="layui-btn layui-btn-primary layui-btn layui-btn-sm" onclick="onRefresh();" lay-event="refresh"><i class="layui-icon"  style="font-size: 20px">&#xe669;</i></button>-->
  </div>
</script>

<script>

	var form;
    layui.use(['element','layer','form','upload', 'table', 'laydate'], function(){
        var  $ = layui.jquery;//jquery
        var lement = layui.element;//面包导航
        var layer = layui.layer;//弹出层
         form = layui.form;
        var upload = layui.upload;
		var table = layui.table;
		var laydate = layui.laydate;

        //预约时间日期
		var date= new Date();
		var year = date.getFullYear();      //年
		var month = date.getMonth() + 1;    //月
		var strDate = date.getDate();       //日
		var hours = date.getHours();        //时
		var minutes = date.getMinutes();    //分
		laydate.render({
			elem: '#servicetime'
			,value: year+"-"+month+"-"+strDate+" "+hours+":"+minutes+":00"
			,isInitValue: true
			,type: 'datetime'
		 });
	
		
		table.render({
			elem: '#contacts'
			,height: 'full-100'
			,data: [{"name":"11111", "phone":"2", "relationship":"3"}]
			,editTrigger: 'dblclick'
			,toolbar: '#contactstools'
			,cols: [[
				,{field:'id', width: '1%', align:'center', title: '序号', hide: true}
				,{field:'name', width: '24%', align:'center', edit: 'text', title: '姓名'}
				,{field:'phone', width: '40%', align:'center', edit: 'text', title: '联系电话'}
				,{field:'relationship', width: '25%', align:'center', edit: 'text', title: '关系'} 
				,{title: '操作', width: '10%', align:'center', toolbar: '#fieldtool', fixed: 'right'}
			]]
		});
		
		table.on('tool(test)', function(obj) {
			var data = obj.data;
			console.log(obj.event);
			
			if (obj.event === 'delete') {
				if (data.name == "") {
					var table_data = table.cache["contacts"];
					table_data.splice(obj.tr.data("index"), 1);
					table.reload("contacts", {data: table_data})
				} else {
					layer.confirm('确定要删除[' + data.name + ']么?',
						{btn:['确定', '取消']},
						function(index, layero) {
							var table_data = table.cache["contacts"];
							table_data.splice(obj.tr.data("index"), 1);
							table.reload("contacts", {data: table_data})
							layer.close(index);
						});
				}
			}
		});
		
		$(document).on('click', '#contacts_add', function(){			
			var table_data = table.cache["contacts"];
			table_data.push({
				"name": "",
				"phone": "",
				"relationship":""});
				
			table.reload("contacts", {data: table_data})
		});
		 
		 //鼠标失去焦点事件
        $(document).ready(function () {
            $("#chinaid").blur(function () {
                var china_id = $(this).val();
				console.log(china_id);
				var age = GetAge(china_id);
				if (age != 0) {
					$("#age").val(age);
				}
				
				var sex = GetSex(china_id);
				if (sex != 0) {
					document.getElementById("sex").value = GetSex(china_id);
					form.render("select");
				}
            })
        });

        //监听提交
        form.on('submit(add)', function(data){
            
			var slow = [];
			var child = $(".seach-box input[type='checkbox']");
			console.log(child);
			child.each(function (index, item) {		
				if (item.checked) {
					slow.push(item.id);
				}
			});
			// 慢病
			console.log(slow);
			data.field["slow"] = JSON.stringify(slow);
			// 联系人
			data.field["contacts"] = JSON.stringify(table.cache["contacts"]);
			console.log(data.field);
			var obj = JSON.parse(data.field["contacts"])
			console.log(obj)
			
            $.ajax({
                type: "post",
                url: BasePath + '/register',
                data: data.field,
                dataType: "json",
				headers: {'Access-Control-Allow-Origin' : Domain,},
				xhrFields: {withCredentials: true},
                success: function(data){
					console.log(data)
                    if(data.code==0){
                        layer.msg("注册成功", {icon: 6,time:2000},function () {
                            window.parent.location.reload();
                            var index = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index);
                        });
                        return false;
                    }else if(data.code==1001) {
						// cookie 失效
						var from = document.getElementById("from").value;
						if (from == "client-list") {
							parent.parent.location.href = "../index.html";
						} else {
							parent.location.href = "../index.html";
						}
                        return false;
					}else{
                        layer.msg(data.msg,{icon:5,time:5000});
						return false;
                    }
                }
            });
        });
		
    })
	
	function onSelClient() {
		layer.open({
			type: 2,
			area: ['880px', '500px'],
			fixed: false, //不固定
			maxmin: true,
			title: "选择老人",
			content: 'client-select.html',
			success:function(layero,index){
				
			}
		});
	}
	
	function onSelService() {
		layer.open({
			type: 2,
			area: ['880px', '500px'],
			fixed: false, //不固定
			maxmin: true,
			title: "选择老人",
			content: 'service-select.html',
			success:function(layero,index){
			
			}
		});
	}
</script>

<script>
    function DoSelectClient(data) {
		form.val("orderadd", {
			name: data["Name"],
			phone: data["Phone"],
			ascription: data["Community"],
			addr: data["Addr"],
		})
	}
	
	function DoSelectService(data) {
		form.val("orderadd", {
			service: data["Name"],
			charge: data["Price"],
		})
	}
</script>

</body>
</html>